# /etc/nginx/sites-available/ai-platform.conf
# Nginx reverse proxy for AI Platform

upstream ai_platform_backend {
    server 127.0.0.1:8000;
    keepalive 32;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api_zone:10m rate=30r/m;
limit_req_zone $http_x_api_key    zone=key_zone:10m rate=60r/m;

server {
    listen 80;
    server_name ai-platform.local;

    # Redirect all HTTP → HTTPS in production.
    # Uncomment if TLS is configured:
    # return 301 https://$host$request_uri;

    # ── Logging ───────────────────────────────────────────────────────────────
    access_log /var/log/nginx/ai-platform-access.log combined;
    error_log  /var/log/nginx/ai-platform-error.log  warn;

    # ── Security headers ──────────────────────────────────────────────────────
    add_header X-Content-Type-Options    nosniff         always;
    add_header X-Frame-Options           DENY            always;
    add_header X-XSS-Protection         "1; mode=block" always;
    add_header Referrer-Policy          "no-referrer"   always;
    add_header Content-Security-Policy  "default-src 'none'" always;

    # ── Request size limit ────────────────────────────────────────────────────
    client_max_body_size 2M;

    # ── Timeouts (LLM inference can be slow) ─────────────────────────────────
    proxy_read_timeout    300s;
    proxy_connect_timeout  10s;
    proxy_send_timeout    300s;

    # ── Health endpoint (no rate limiting, for load balancers) ────────────────
    location = /health {
        proxy_pass         http://ai_platform_backend;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header   Connection        "";
    }

    # ── API routes ─────────────────────────────────────────────────────────────
    location /operations/ {
        limit_req zone=api_zone burst=10 nodelay;
        limit_req zone=key_zone burst=20 nodelay;

        proxy_pass         http://ai_platform_backend;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header   Connection        "";
        proxy_buffering    off;
    }

    location / {
        limit_req zone=api_zone burst=5 nodelay;

        proxy_pass         http://ai_platform_backend;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header   Connection        "";
    }
}

# ── HTTPS (uncomment and configure TLS certificate paths) ─────────────────────
# server {
#     listen 443 ssl http2;
#     server_name ai-platform.local;
#
#     ssl_certificate     /etc/nginx/ssl/ai-platform.crt;
#     ssl_certificate_key /etc/nginx/ssl/ai-platform.key;
#     ssl_protocols       TLSv1.2 TLSv1.3;
#     ssl_ciphers         HIGH:!aNULL:!MD5;
#     ssl_session_cache   shared:SSL:10m;
#     ssl_session_timeout 10m;
#
#     # Include the same location blocks as above.
# }
